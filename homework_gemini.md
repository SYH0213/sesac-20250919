# CRAG 미니 프로젝트 고도화: 개발 및 학습 내용 보고서

## 1. RAG 프로젝트 고도화: CRAG 및 동적 UI 구현

## 1. RAG 프로젝트 고도화: CRAG 및 동적 UI 구현

`homework.md`의 요구사항에 따라, 기존 RAG 프로젝트의 아키텍처와 사용자 경험을 대폭 개선했습니다. 주요 업데이트는 다음과 같습니다.

*   **동적 문서 처리 UI (Gradio):**
    *   하드코딩된 파일 경로를 제거하고, 사용자가 UI에서 직접 PDF를 선택하거나 업로드할 수 있도록 개선했습니다.
    *   선택된 문서를 기반으로 독립적인 데이터베이스와 저장소 경로(`chroma_db/문서명` 등)를 동적으로 생성하여, 여러 문서를 효율적으로 관리할 수 있는 기반을 마련했습니다.

*   **지능형 RAG 파이프라인 (LangGraph & CRAG):**
    *   **지능형 라우팅**: LangGraph를 도입하여, 사용자 입력을 '단순 대화'와 '정보성 질문'으로 먼저 분류합니다. 대화형 입력은 불필요한 검색 과정을 건너뛰고 즉시 답변을 생성하여 응답 속도와 효율성을 높였습니다. (v2.0)
    *   **품질 평가 (Corrective)**: 검색된 문서가 질문과 관련 없는 경우, LLM이 스스로 이를 판단하여 답변 생성에서 제외합니다. (Hallucination 억제)
    *   **정보 보강 (Augmented)**: 관련 문서가 없다고 판단되면, 질문을 웹 검색에 적합하게 재작성한 뒤, 웹 검색을 통해 외부 정보를 탐색하여 답변을 생성합니다.

*   **핵심 로직 개선:**
    *   **PDF 파서 교체**: `LlamaParse` 의존성을 제거하고, Gemini API를 직접 호출하여 PDF 텍스트와 테이블을 추출하는 `gemini_parser.py` 모듈을 구현했습니다. (v2.2)
    *   **답변 언어 고정**: 챗봇의 모든 답변이 일관되게 한국어로 생성되도록 시스템 프롬프트를 강화했습니다. (v2.1)

이러한 개선 사항들은 `CRAG.py`의 LangGraph 워크플로우와 Gradio 이벤트 핸들러, 그리고 `gemini_parser.py` 모듈을 통해 유기적으로 구현되었습니다.

---

## 2. 학습 내용 정리: 심층 문제 해결 과정

이번 프로젝트 고도화 과정에서 겪었던 가장 큰 어려움은 **예상치 못한 API 오류를 해결하는 과정**이었습니다. 이 경험은 단순한 코딩을 넘어, 문제의 근본 원인을 추적하는 시스템적인 디버깅 능력을 기르는 데 큰 도움이 되었습니다.

### 상황: 잘 작동하던 기능이 갑자기 특정 PDF에서 오류를 일으키다

부트캠프 컴퓨터에서 잘 작동하던 기능이, 어느 순간부터 특정 PDF 파일을 처리할 때 `google.genai.errors.ClientError: 400 INVALID_ARGUMENT` 오류를 발생시키기 시작했습니다. 이처럼 동일한 코드와 파일임에도 불구하고 어제는 되고 오늘은 안 되는 현상 때문에, 처음에는 `pip list`로 확인한 파이썬 라이브러리 버전이 달라졌거나 코드 자체에 문제가 생긴 것은 아닌지 의심하며 원인을 추적하기 시작했습니다.

### 잘못된 가설과 막다른 길

문제 해결을 위해 여러 가설을 세우고 검증하는 과정을 거쳤습니다.

1.  **가설 1: API 할당량 소진**: 반복적인 테스트로 인해 API 무료 할당량이 소진되었을 것이라 추측했습니다. 실제로 `429 RESOURCE_EXHAUSTED` 오류가 발생하기도 하여 이 가설에 무게가 실렸습니다. 하지만 부트캠프에서 제공된 **유료 API 키**를 사용 중이라는 사실을 확인하면서 이 가설은 폐기되었습니다.

2.  **가설 2: API 인증 방식의 문제**: 유료 키임에도 불구하고 오류 메시지에 `free_tier_requests` (무료 등급 요청)라는 문구가 포함된 것을 보고, API 인증 방식 자체의 문제일 수 있다고 판단했습니다. API 키만 사용하는 단순 인증 대신, `gcloud` 명령줄 도구를 통해 프로젝트 ID를 명시적으로 설정하는 `Application Default Credentials` 방식을 시도했으나, 이 또한 근본적인 해결책이 아니었습니다.

### 돌파구: 사용자의 발견과 진짜 원인

코드와 API 설정의 미로에 갇혀있을 때, **프로젝트를 진행한 사용자가 직접 결정적인 단서를 발견했습니다.**

**진짜 원인은 바로 운영체제(OS) 수준의 "파일 연결(기본 프로그램)" 설정**이었습니다.

- **문제**: 오류가 발생하던 PDF 파일의 기본 프로그램이 윈도우에서 **'한컴 PDF'**로 설정되어 있었습니다.
- **메커니즘**: 파이썬의 `google-generativeai` 라이브러리는 파일을 업로드할 때, OS의 파일 연결 설정을 참고하여 파일의 종류(`mime_type`)를 추론합니다. '한컴 PDF'와의 연결 때문에, 라이브러리는 이 파일의 `mime_type`을 표준적인 `application/pdf`가 아닌, **비표준적인 `mime_type`으로 잘못 인식**했던 것입니다.
- **결과**: 잘못된 `mime_type` 정보와 함께 파일이 구글 서버로 업로드되었고, `generate_content` 모델이 이 파일을 처리하려 할 때, "처리할 수 없는 종류의 파일"이라 판단하여 `400 INVALID_ARGUMENT` 오류를 반환했던 것입니다.

사용자가 직접 파일의 기본 프로그램을 표준 PDF 리더(Adobe Acrobat 등)로 변경하자, 파이썬이 `mime_type`을 `application/pdf`로 올바르게 인식하게 되었고, 모든 문제가 해결되었습니다.

### 교훈: 시스템 전체를 보는 눈

이번 경험을 통해 다음과 같은 중요한 교훈을 얻었습니다.

> **API 관련 오류의 근본 원인은 코드나 API 키 자체를 넘어, 코드가 실행되는 운영체제 환경이나 데이터 자체의 숨겨진 속성 등 예상치 못한 곳에 있을 수 있다.**

오류 메시지에만 매몰되지 않고, 문제가 발생하는 상황과 그렇지 않은 상황의 **환경적 차이**를 집요하게 파고들어 근본 원인을 찾아낸 좋은 경험이었습니다. 이는 앞으로 더 복잡한 시스템을 다룰 때 큰 자산이 될 것입니다.

---

## 3. 완성 코드 제출

위의 모든 기능과 학습 내용이 반영된 최종 `CRAG.py` 및 `gemini_parser.py` 코드를 제출합니다.